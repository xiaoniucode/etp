<!DOCTYPE html>
<html>
<head>
    <title>IP访问控制</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/static/assets/layui/css/layui.css" rel="stylesheet">
    <link href="/static/assets/css/app.css" rel="stylesheet">
</head>
<body>
<div class="layui-container" style="padding-top: 15px">
    <form class="layui-form" lay-filter="accessControlForm">
        <blockquote class="layui-elem-quote">
            白名单：只有在允许项中的访问来源IP可以访问<br>
            黑名单：除了在拒绝项中的访问来源IP不可以访问，其他都可以访问
        </blockquote>
        <div style="margin-bottom: 15px; display: flex; align-items: center;">
            <label style="width: 80px;">访问控制</label>
            <input type="checkbox" name="enable" lay-skin="switch" lay-text="开启|关闭" lay-filter="enableSwitch">
        </div>

        <div style="margin-bottom: 15px; display: flex; align-items: center;">
            <label style="width: 80px;">控制模式</label>
            <div>
                <input type="radio" name="mode" value="whitelist" title="白名单" lay-filter="mode">
                <input type="radio" name="mode" value="blacklist" title="黑名单" lay-filter="mode">
            </div>
        </div>

        <div style="margin-bottom: 10px;">
            <label>IP规则列表</label>
        </div>
        <table class="layui-hide" id="ipRuleTable"></table>

        <script type="text/html" id="ipRuleToolbar">
            <div class="layui-btn-container">
                <button type="button" class="layui-btn layui-btn-sm" lay-event="add">
                    <i class="layui-icon layui-icon-add-1"></i> 新增规则
                </button>
            </div>
        </script>
    </form>
</div>

<script src="/static/assets/layui/layui.js"></script>
<script src="/static/assets/js/ajax.js"></script>
<script src="/static/assets/js/common.js"></script>
<script>
    layui.use(['form', 'jquery', 'layer', 'Rest', 'table'], function () {
        const form = layui.form;
        const $ = layui.$;
        const layer = layui.layer;
        const Rest = layui.Rest;
        const table = layui.table;

        const proxyId = getQueryParam("proxyId");

        if (!proxyId) {
            layer.msg('缺少代理ID', {icon: 2});
            return;
        }

        let accessControlData = null;

        function loadAccessControlData() {
            Rest.get('/api/access-controls/proxy/' + proxyId).then(data => {
                    accessControlData = data;
                    renderAccessControlData(data);
                    renderIpRuleTable(data.rules || []);
                })
                .catch(err => {
                    console.error('加载数据失败:', err);
                });
        }

        function renderAccessControlData(data) {
            if (data.enable) {
                $('input[name="enable"]').prop('checked', true);
            } else {
                $('input[name="enable"]').prop('checked', false);
            }
            form.render('checkbox');

            const modeNum = data.mode || 0;
            const mode = modeNum === 1 ? 'whitelist' : 'blacklist';
            $('input[name="mode"][value="' + mode + '"]').prop('checked', true);
            form.render('radio');
        }

        function renderIpRuleTable(rules) {
            table.render({
                elem: '#ipRuleTable',
                data: rules,
                text: '空空如也',
                skin: 'line',
                cellMinWidth: 80,
                toolbar: '#ipRuleToolbar',
                cols: [[
                    {field: 'LAY_INDEX', width: 80, title: '序号', type: 'numbers'},
                    {
                        field: 'cidr', title: 'IP地址/掩码', templet: function (d) {
                            // 只有新增的规则（id以new_开头）可以编辑
                            if (d.id && d.id.toString().startsWith('new_')) {
                                return `<input type="text" class="layui-input" value="${d.cidr || ''}" lay-event="editCidr">`;
                            } else {
                                return d.cidr || '';
                            }
                        }
                    },
                    {
                        field: 'ruleType', title: '访问规则', templet: function (d) {
                            return `
                            <div class="layui-form">
                                <input type="radio" name="ruleType${d.id || Date.now()}" value="1" title="允许" ${d.ruleType === 1 ? 'checked' : ''} lay-event="updateRule" style="margin-right: 20px;">
                                <input type="radio" name="ruleType${d.id || Date.now()}" value="0" title="拒绝" ${d.ruleType === 0 ? 'checked' : ''} lay-event="updateRule">
                            </div>
                        `;
                        }
                    },
                    {
                        title: '操作', width: 150, templet: function (d) {
                            if (d.id && d.id.toString().startsWith('new_')) {
                                return `
                                <div class="layui-btn-container" style="display: flex; gap: 5px;">
                                    <button type="button" class="layui-btn layui-btn-xs layui-btn-normal" lay-event="save">
                                        <i class="layui-icon layui-icon-ok"></i>
                                    </button>
                                    <button type="button" class="layui-btn layui-btn-xs layui-btn-danger" lay-event="delete">
                                        <i class="layui-icon layui-icon-close"></i>
                                    </button>
                                </div>
                            `;
                            } else {
                                return `
                                <button type="button" class="layui-btn layui-btn-xs layui-btn-danger" lay-event="delete">
                                    <i class="layui-icon layui-icon-delete"></i>
                                </button>
                            `;
                            }
                        }
                    }
                ]]
            });
        }

        table.on('tool(ipRuleTable)', function (obj) {
            const data = obj.data;
            const event = obj.event;
            if (event === 'updateRule') {
                const target = obj.tr.find('input[name="ruleType' + (data.id || Date.now()) + '"]:checked');
                const ruleType = parseInt(target.val());
                console.log('更新规则为:', ruleType === 1 ? '允许' : '拒绝', 'CIDR:', data.cidr, 'ruleType:', ruleType);

                if (data.id && !data.id.toString().startsWith('new_')) {
                    Rest.put('/api/access-controls/rules', {
                        proxyId: proxyId,
                        ruleType: ruleType
                    }).then(() => {
                        layer.msg('规则已更新', {icon: 1, time: 1000});
                        obj.update({
                            ruleType: ruleType
                        });
                    }).catch(err => {
                        obj.tr.find('input[name="ruleType' + data.id + '"][value="' + data.ruleType + '"]').prop('checked', true);
                        form.render('radio');
                        layer.msg('更新规则失败', {icon: 2, time: 1000});
                    });
                } else {
                    obj.update({
                        ruleType: ruleType
                    });
                }
            } else if (event === 'editCidr') {
                const target = obj.tr.find('input[lay-event="editCidr"]');
                const cidr = target.val();
            } else if (event === 'save') {
                const cidrInput = obj.tr.find('input[lay-event="editCidr"]');
                const cidr = cidrInput.val().trim();

                if (!cidr) {
                    layer.msg('请输入 IP 地址/掩码', {icon: 2});
                    return;
                }
                const cidrPattern = /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}(\/\d{1,2})?$/;
                if (!cidrPattern.test(cidr)) {
                    layer.msg('IP 地址/掩码格式不正确', {icon: 2});
                    return;
                }
                // 获取选中的规则类型
                const ruleTypeInput = obj.tr.find('input[name="ruleType' + data.id + '"]:checked');
                const ruleType = ruleTypeInput ? parseInt(ruleTypeInput.val()) : 1;
                Rest.post('/api/access-controls/rules', {
                    proxyId: proxyId,
                    cidr: cidr,
                    ruleType: ruleType
                }).then(() => {
                    layer.msg('保存成功', {icon: 1, time: 600}, function () {
                        loadAccessControlData();
                    });
                }).catch(err => {
                    console.error('保存失败:', err);
                });
            } else if (event === 'delete') {
                if (data.id && data.id.toString().startsWith('new_')) {
                    const tableData = table.cache['ipRuleTable'] || [];
                    // 过滤掉要删除的新增规则
                    const filteredData = tableData.filter(row => row.id !== data.id);
                    table.reload('ipRuleTable', {
                        data: filteredData
                    });
                    console.log('删除新增规则:', data.cidr, 'ID:', data.id);
                } else {
                    layer.confirm('确定删除？', {
                        icon: 2,
                        title: '删除确认',
                        btn: ['确认删除', '取消']
                    }, function (index) {
                        Rest.delete('/api/access-controls/rules/' + data.id).then(() => {
                            layer.msg('删除成功', {icon: 1, time: 600});
                            loadAccessControlData();
                        }).finally(() => {
                            layer.close(index);
                        });
                    });
                }
            }
        });

        table.on('toolbar(ipRuleTable)', function (obj) {
            const event = obj.event;

            if (event === 'add') {
                const tableData = table.cache['ipRuleTable'] || [];
                const hasUnsavedRow = tableData.some(row => row.id && row.id.toString().startsWith('new_'));

                if (hasUnsavedRow) {
                    layer.msg('请先保存或删除当前新增的规则', {icon: 2});
                    return;
                }
                const newRule = {
                    id: 'new_' + Date.now(),
                    cidr: '',
                    ruleType: 1
                };
                tableData.push(newRule);
                table.reload('ipRuleTable', {
                    data: tableData
                });
            }
        });

        form.on('switch(enableSwitch)', function (obj) {
            const enable = obj.elem.checked;
            if (!accessControlData) {
                layer.msg('加载数据失败，请刷新页面重试', {icon: 2});
                obj.elem.checked = !enable;
                form.render('checkbox');
                return;
            }

            Rest.put('/api/access-controls', {
                proxyId: proxyId,
                enable: enable,
                mode: accessControlData.mode
            }).then(() => {
                layer.msg(enable ? '访问控制已开启' : '访问控制已关闭', {icon: 1, time: 1000});
                accessControlData.enable = enable ? 1 : 0;
            }).catch(err => {
                obj.elem.checked = !enable;
                form.render('checkbox');
                layer.msg('更新失败，请稍后重试', {icon: 2});
            });
        });

        form.on('radio(mode)', function (obj) {
            const modeStr = obj.value;
            const mode = modeStr === 'whitelist' ? 1 : 0;

            if (!accessControlData) {
                layer.msg('加载数据失败，请刷新页面重试', {icon: 2});
                const oldMode = 0;
                const oldModeStr = oldMode === 1 ? 'whitelist' : 'blacklist';
                $('input[name="mode"][value="' + oldModeStr + '"]').prop('checked', true);
                form.render('radio');
                return;
            }

            Rest.put('/api/access-controls', {
                proxyId: proxyId,
                enable: accessControlData.enable,
                mode: mode
            }).then(() => {
                layer.msg('控制模式已更新', {icon: 1, time: 1000});
                accessControlData.mode = mode;
            }).catch(err => {
                const oldMode = accessControlData.mode;
                const oldModeStr = oldMode === 1 ? 'whitelist' : 'blacklist';
                $('input[name="mode"][value="' + oldModeStr + '"]').prop('checked', true);
                form.render('radio');
                layer.msg('更新失败，请稍后重试', {icon: 2});
            });
        });
        loadAccessControlData();
    });
</script>
</body>
</html>