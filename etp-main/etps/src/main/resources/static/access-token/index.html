<!DOCTYPE html>
<html>
<head>
    <title>访问令牌管理</title>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/static/assets/layui/css/layui.css" rel="stylesheet">
    <link href="/static/assets/css/app.css" rel="stylesheet">
</head>
<body>
<table class="layui-hide" id="tokenTable" lay-filter="tokenTable"></table>
<script type="text/html" id="headerToobar">
    <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm layui-btn-normal" lay-event="add">
            <i class="layui-icon layui-icon-add-1"></i> 新增
        </button>
        <button class="layui-btn layui-btn-sm layui-btn-danger" lay-event="batchDelete">
            <i class="layui-icon layui-icon-delete"></i> 批量删除
        </button>
        <button class="layui-btn layui-btn-sm" lay-event="flush">
            <i class="layui-icon layui-icon-refresh"></i> 刷新
        </button>
    </div>
</script>



<script type="text/html" id="barTools">
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="delete">删除</a>
    <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="copy">复制Token</a>
</script>

<script src="/static/assets/layui/layui.js"></script>
<script src="/static/assets/js/ajax.js"></script>
<script src="/static/assets/js/copy.js"></script>
<script>
    layui.use(['table', 'layer', 'jquery', 'Rest'], function () {
        const table = layui.table;
        const layer = layui.layer;
        const $ = layui.$;
        const Rest = layui.Rest;

        // 渲染表格
        const tokenTable = table.render({
            elem: '#tokenTable',
            text: "空空如也",
            skin: "line",
            url: '/api/access-token',
            toolbar: '#headerToobar',
            cellMinWidth: 80,
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem("auth_token")
            },
            cols: [[
                {type: 'checkbox', fixed: 'left'},
                {field: 'id', title: 'ID', width: 80, sort: true},
                {field: 'name', title: '名称', width: 180},
                {field: 'token', title: '访问令牌', minWidth: 400},
                {field: 'onlineClient', title: '在线连接', minWidth: 100},
                {field: 'maxClient', title: '连接限制', minWidth: 100},
                {title: '操作', width: 200, toolbar: '#barTools', fixed: 'right'}
            ]],
            error: function (res, msg) {
                console.log(res, msg)
            }
        });



        // 工具栏事件
        table.on('tool(tokenTable)', function (obj) {
            const data = obj.data;
            if (obj.event === 'edit') {
                // 编辑事件
                layer.open({
                    title: '编辑访问令牌',
                    type: 2,
                    offset: '30px',
                    shade: false,
                    area: ['40%', '40%'],
                    content: '/access-token/edit.html?id=' + data.id,
                    end: function () {
                        // 关闭弹窗后刷新表格
                        tokenTable.reload();
                    }
                });
            } else if (obj.event === 'delete') {
                // 删除事件
                layer.confirm('确定删除「' + data.name + '」访问令牌吗？', {
                    icon: 2,
                    title: '危险操作确认',
                    skin: 'layui-layer-molv',
                    btn: ['确认删除', '我再想想'],
                }, function (index) {
                    Rest.delete('/api/access-token/' + data.id).then(res => {
                        tokenTable.reload();
                        layer.msg("删除成功", {time: 2000});
                    });
                    layer.close(index);
                });
            } else if (obj.event === 'copy') {
                // 复制Token事件
                ClipMaster.copy(data.token);
            }
        });

        // 操作工具栏
        table.on('toolbar(tokenTable)', function (obj) {
            if (obj.event === 'add') {
                layer.open({
                    title: '新增访问令牌',
                    type: 2,
                    offset: '30px',
                    shade: false,
                    area: ['40%', '40%'],
                    content: '/access-token/add.html',
                    end: function () {
                        // 关闭弹窗后刷新表格
                        tokenTable.reload();
                    }
                });
            } else if (obj.event === 'flush') {
                tokenTable.reload()
            } else if (obj.event === 'batchDelete') {
                const checkStatus = table.checkStatus('tokenTable');
                const data = checkStatus.data;
                if (data.length === 0) {
                    layer.msg('请选择要删除的访问令牌', {icon: 2});
                    return;
                }
                const ids = data.map(item => item.id);
                const names = data.map(item => item.name).join('、');
                layer.confirm('确定删除选中的访问令牌：「' + names + '」吗？',
                    {
                        icon: 2,
                        title: '危险操作确认',
                        skin: 'layui-layer-molv',
                        btn: ['确认删除', '我再想想'],
                    }, function (index) {
                        Rest.delete('/api/access-token', {ids: ids}).then(res => {
                            tokenTable.reload()
                            layer.msg('删除成功', {time: 2000});
                        }).catch(err => {
                            layer.msg('删除失败', {icon: 2});
                        })
                    })
            }
        })
    });
</script>
</body>
</html>
