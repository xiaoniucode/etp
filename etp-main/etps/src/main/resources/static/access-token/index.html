<!DOCTYPE html>
<html>
<head>
    <title>访问令牌管理</title>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/static/assets/layui/css/layui.css" rel="stylesheet">
    <link href="/static/assets/css/app.css" rel="stylesheet">
</head>
<body>
<div class="layui-container" style="padding: 15px;">
    <div class="layui-row">
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-header">
                    <div class="layui-row">
                        <div class="layui-col-md6">
                            <h3>访问令牌管理</h3>
                        </div>
                        <div class="layui-col-md6 text-right">
                            <button class="layui-btn layui-btn-sm layui-btn-normal" id="addTokenBtn">
                                <i class="layui-icon layui-icon-add-1"></i> 新增
                            </button>
                            <button class="layui-btn layui-btn-sm" id="refreshBtn">
                                <i class="layui-icon layui-icon-refresh-3"></i> 刷新
                            </button>
                        </div>
                    </div>
                </div>
                <div class="layui-card-body">
                    <table class="layui-hide" id="tokenTable" lay-filter="tokenTable"></table>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/html" id="toolbar">
    <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm layui-btn-normal" id="addTokenBtn">
            <i class="layui-icon layui-icon-add-1"></i> 新增
        </button>
        <button class="layui-btn layui-btn-sm" id="refreshBtn">
            <i class="layui-icon layui-icon-refresh-3"></i> 刷新
        </button>
    </div>
</script>

<script type="text/html" id="barTools">
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="delete">删除</a>
    <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="copy">复制Token</a>
</script>

<script src="/static/assets/layui/layui.js"></script>
<script src="/static/assets/js/ajax.js"></script>
<script src="/static/assets/js/copy.js"></script>
<script>
    layui.use(['table', 'layer', 'jquery', 'Rest'], function () {
        const table = layui.table;
        const layer = layui.layer;
        const $ = layui.$;
        const Rest = layui.Rest;

        // 渲染表格
        const tokenTable = table.render({
            elem: '#tokenTable',
            url: '/api/access-token',
            method: 'GET',
            request: {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem("auth_token")
                }
            },
            cols: [[
                {field: 'id', title: 'ID', width: 80, sort: true},
                {field: 'name', title: '名称', width: 180},
                {field: 'token', title: 'Token', minWidth: 300},
                {field: 'maxClient', title: '最大客户端数', width: 120},
                {title: '操作', width: 200, toolbar: '#barTools', fixed: 'right'}
            ]],
            page: false,
            loading: true,
            text: {
                none: '暂无访问令牌数据'
            }
        });

        // 工具栏事件
        table.on('tool(tokenTable)', function (obj) {
            const data = obj.data;
            if (obj.event === 'edit') {
                // 编辑事件
                layer.open({
                    title: '编辑访问令牌',
                    type: 2,
                    offset: '30px',
                    shade: false,
                    area: ['40%', '40%'],
                    content: '/access-token/edit.html?id=' + data.id,
                    end: function () {
                        // 关闭弹窗后刷新表格
                        tokenTable.reload();
                    }
                });
            } else if (obj.event === 'delete') {
                // 删除事件
                layer.confirm('确定删除「' + data.name + '」访问令牌吗？', {
                    icon: 2,
                    title: '危险操作确认',
                    skin: 'layui-layer-molv',
                    btn: ['确认删除', '我再想想'],
                }, function (index) {
                    Rest.delete('/api/access-token/' + data.id).then(res => {
                        tokenTable.reload();
                        layer.msg("删除成功", {time: 2000});
                    });
                    layer.close(index);
                });
            } else if (obj.event === 'copy') {
                // 复制Token事件
                ClipMaster.copy(data.token);
            }
        });

        // 新增按钮事件
        $('#addTokenBtn').on('click', function () {
            layer.open({
                title: '新增访问令牌',
                type: 2,
                offset: '30px',
                shade: false,
                area: ['40%', '40%'],
                content: '/access-token/add.html',
                end: function () {
                    // 关闭弹窗后刷新表格
                    tokenTable.reload();
                }
            });
        });

        // 刷新按钮事件
        $('#refreshBtn').on('click', function () {
            tokenTable.reload();
            layer.msg('刷新成功', {time: 1000});
        });
    });
</script>
</body>
</html>
