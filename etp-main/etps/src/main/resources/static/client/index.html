<!DOCTYPE html>
<html>
<head>
    <title>客户端管理</title>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/static/assets/layui/css/layui.css" rel="stylesheet">
    <link href="/static/assets/css/app.css" rel="stylesheet">
</head>
<body>
<table class="layui-hide" id="clientTable" lay-filter="clientTable"></table>
<script type="text/html" id="headerToobar">
    <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm layui-btn-danger" lay-event="batchDelete">
            <i class="layui-icon layui-icon-delete"></i> 批量删除
        </button>
        <button class="layui-btn layui-btn-sm" lay-event="flush">
            <i class="layui-icon layui-icon-refresh"></i> 刷新
        </button>
    </div>
</script>

<script type="text/html" id="barTools">
    <a class="layui-btn layui-btn-xs" lay-event="detail">详情</a>
    <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="kickout" {{!d.isOnline
       ? 'style="opacity: 0.5; pointer-events: none;"' : ''}}>剔除</a>
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="delete">删除</a>
</script>

<script src="/static/assets/layui/layui.js"></script>
<script src="/static/assets/js/ajax.js"></script>
<script>
    layui.use(['table', 'layer', 'jquery', 'Rest'], function () {
        const table = layui.table;
        const layer = layui.layer;
        const $ = layui.$;
        const Rest = layui.Rest;

        // 渲染表格
        const clientTable = table.render({
            elem: '#clientTable',
            text: "空空如也",
            skin: "line",
            url: '/api/clients',
            toolbar: '#headerToobar',
            cellMinWidth: 80,
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem("auth_token")
            },
            cols: [[
                {type: 'checkbox', fixed: 'left'},
                {field: 'id', title: '客户端标识'},
                {field: 'name', title: '名称'},
                {field: 'os', title: '操作系统'},
                {field: 'arch', title: '系统架构'},
                {field: 'version', title: '客户端版本'},
                {
                    field: 'isOnline', title: '在线状态', templet: function (d) {
                        return d.isOnline ? '<span style="color: #52c41a;">在线</span>' : '<span style="color: #999;">离线</span>';
                    }
                },
                {title: '操作', width: 250, toolbar: '#barTools', fixed: 'right'}
            ]],
            error: function (res, msg) {
                console.log(res, msg)
            }
        });

        // 工具栏事件
        table.on('tool(clientTable)', function (obj) {
            const data = obj.data;
            if (obj.event === 'detail') {
                // 详情事件
                const detailHtml = `
                    <div style="padding: 20px;">
                        <table class="layui-table">
                            <tr>
                                <th width="120">客户端标识</th>
                                <td>${data.id}</td>
                            </tr>
                            <tr>
                                <th>名称</th>
                                <td>${data.name}</td>
                            </tr>
                            <tr>
                                <th>操作系统</th>
                                <td>${data.os}</td>
                            </tr>
                            <tr>
                                <th>架构</th>
                                <td>${data.arch}</td>
                            </tr>
                            <tr>
                                <th>版本</th>
                                <td>${data.version}</td>
                            </tr>
                            <tr>
                                <th>在线状态</th>
                                <td>${data.isOnline ? '在线' : '离线'}</td>
                            </tr>

                            <tr>
                                <th>创建时间</th>
                                <td>${data.createdAt}</td>
                            </tr>
                            <tr>
                                <th>更新时间</th>
                                <td>${data.updatedAt}</td>
                            </tr>
                        </table>
                    </div>
                `;
                layer.open({
                    title: '客户端详情',
                    type: 1,
                    offset: '30px',
                    shade: false,
                    area: ['500px', 'auto'],
                    content: detailHtml
                });
            } else if (obj.event === 'kickout') {
                // 剔除事件
                layer.confirm('确定剔除「' + data.name + '」客户端吗？', {
                    icon: 2,
                    title: '危险操作确认',
                    skin: 'layui-layer-molv',
                    btn: ['确认', '再想想'],
                }, function (index) {
                    Rest.put('/api/clients/' + data.id + '/kickout').then(res => {
                        clientTable.reload();
                        layer.msg("剔除成功", {time: 2000});
                    });
                    layer.close(index);
                });
            } else if (obj.event === 'delete') {
                // 删除事件
                layer.confirm('确定删除「' + data.name + '」客户端吗？', {
                    icon: 2,
                    title: '危险操作确认',
                    skin: 'layui-layer-molv',
                    btn: ['确认删除', '我再想想'],
                }, function (index) {
                    Rest.delete('/api/clients/' + data.id).then(res => {
                        clientTable.reload();
                        layer.msg("删除成功", {time: 2000});
                    });
                    layer.close(index);
                });
            }
        });

        // 操作工具栏
        table.on('toolbar(clientTable)', function (obj) {
            if (obj.event === 'flush') {
                clientTable.reload()
            } else if (obj.event === 'batchDelete') {
                const checkStatus = table.checkStatus('clientTable');
                const data = checkStatus.data;
                if (data.length === 0) {
                    layer.msg('请选择要删除的客户端', {icon: 2});
                    return;
                }
                const ids = data.map(item => item.id);
                const names = data.map(item => item.name).join('、');
                layer.confirm('确定删除选中的客户端：「' + names + '」吗？',
                    {
                        icon: 2,
                        title: '危险操作确认',
                        skin: 'layui-layer-molv',
                        btn: ['确认删除', '我再想想'],
                    }, function (index) {
                        Rest.delete('/api/clients', {ids: ids}).then(res => {
                            clientTable.reload()
                            layer.msg('删除成功', {time: 2000});
                        }).catch(err => {
                            layer.msg('删除失败', {icon: 2});
                        })
                    })
            }
        })
    });
</script>
</body>
</html>
