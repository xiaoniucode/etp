<!DOCTYPE html>
<html lang="en">
<head>
    <title>映射</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link href="/static/layui/css/layui.css" rel="stylesheet">
</head>
<body>
<table class="layui-hide" id="proxy" lay-filter="proxy"></table>
<script type="text/html" id="headerToobar">
    <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm" lay-event="add">新增</button>
        <button class="layui-btn layui-btn-sm" lay-event="flush">刷新</button>
    </div>
</script>
<script type="text/html" id="post_table_tool">
    <div class="layui-clear-space">
        <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
        <a class="layui-btn layui-btn-xs" lay-event="delete">删除</a>
    </div>
</script>
<script src="/static/layui/layui.js"></script>
<script>
    layui.use(['form', 'table', 'dropdown','jquery'], function () {
        const table = layui.table;
        const $ = layui.$;
        table.render({
            elem: '#proxy',
            text: "空空如也",
            skin: "line",
            url: '/proxy/list',
            toolbar: '#headerToobar',
            cellMinWidth: 80,
            cols: [[
                {field: 'clientName', fixed: 'left', width: 150, title: '客户端', sort: true},
                {field: 'name', title: '代理名称'},
                {
                    field: 'type', title: '协议', sort: true, templet: function (d) {
                        if (d.type === "tcp") {
                            return ' <span class="layui-badge layui-bg-green">TCP</span>';
                        } else if (d.type === "http") {
                            return '<span class="layui-badge">HTTP</span>';
                        }
                    }
                },
                {field: 'remotePort', sort: true, title: '公网端口'},
                {field: 'localPort', sort: true, title: '内网端口'},
                {
                    field: 'status', width: 120, title: '状态', sort: true, templet: function (d) {
                        const isChecked = d.status === 1 ? 'checked' : '';
                        return '<input type="checkbox" lay-skin="switch" lay-text="开启|关闭" lay-event="statusSwitch" ' + isChecked + '>';
                    }
                },
                {fixed: 'right', title: '操作', width: 134, minWidth: 125, templet: '#post_table_tool'}
            ]],
            error: function (res, msg) {
                console.log(res, msg)
            }
        });
        //单元格操作事件
        table.on('tool(proxy)', function (obj) {
            const data = obj.data;
             if (obj.event === 'edit') {
                layer.open({
                    title: '编辑',
                    type: 2,
                    offset: '30px',
                    shade: false,
                    area: ['60%', '60%'],
                    content: '/proxy/edit.html?id=' + data.id,
                    end: function () {
                        layui.table.reload('proxy');
                    }
                });
            } else if (obj.event === 'delete') {
                 layer.confirm('确定删除「' + data.name + '」代理吗？<br>此操作将会关闭已经建立的连接！',
                     {
                         icon: 2,
                         title:'危险操作确认',
                         skin: 'layui-layer-molv',
                         btn: ['确认删除', '我再想想'],
                     }, function(index){
                         $.ajax({
                             url: '/proxy/del',
                             type: 'delete',
                             contentType: 'application/json',
                             data: JSON.stringify({id: data.id,secretKey:data.secretKey}),
                             headers: {},
                             success: function (res) {
                                 if (res.code === 0) {
                                     table.reload('proxy')
                                     layer.msg("删除成功", {time: 2000});
                                 } else {
                                     layer.msg(res.message, {time: 2000});
                                 }
                             },
                         });
                     })

            }else if (obj.event==='statusSwitch'){
                 const loading = layer.msg('正在切换...', {icon: 16, shade: 0.3, time: 0});
                 $.ajax({
                     url: '/proxy/switch-proxy-status',
                     type: 'put',
                     contentType: 'application/json',
                     data: JSON.stringify({id: data.id, secretKey: data.secretKey}),
                     success: function (res) {
                         layer.close(loading);
                         if (res.code === 0) {
                             layer.msg('切换成功', {icon: 1});
                         } else {
                             layer.msg(res.message, {icon: 2});
                             obj.update({ status: data.status });//回滚状态
                         }
                     },
                     error: function () {
                         layer.close(loading);
                         layer.msg('网络错误', {icon: 2});
                         obj.update({ status: data.status }); // 回滚
                     }
                 });

             }
        })
        //操作工具栏
        table.on('toolbar(proxy)', function (obj) {
            if (obj.event === 'add') {
                layer.open({
                    title: '新增映射',
                    type: 2,
                    offset: '30px',
                    shade: false,
                    area: ['60%', '60%'],
                    content: '/proxy/add.html',
                    end: function () {
                        layui.table.reload('proxy');
                    }
                });
            } else if (obj.event === 'flush') {
                table.reload('proxy')
            }
        })
    });
</script>
</body>
