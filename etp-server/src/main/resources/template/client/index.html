<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>客户端</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/static/layui/css/layui.css" rel="stylesheet">
</head>
<body>
<blockquote class="layui-elem-quote">
    Token唯一标识一个客户端，用于与etp服务端建立连接，请妥善保管，不要泄露！
</blockquote>
<table class="layui-hide" id="client" lay-filter="client"></table>

<script type="text/html" id="headerToolbar">
    <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm layui-btn-normal" lay-event="add">
            <i class="layui-icon layui-icon-add-1"></i> 新增
        </button>
        <button class="layui-btn layui-btn-sm" lay-event="flush">
            <i class="layui-icon layui-icon-refresh-3"></i> 刷新
        </button>
    </div>
</script>
<script type="text/html" id="tableToolbar">
    <div class="layui-clear-space">
        {{# if(d.status === 1){ }}
        <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="kickout">
            <i class="layui-icon layui-icon-logout"></i> 踢掉
        </a>
        {{# } else { }}
        <a class="layui-btn layui-btn-xs layui-btn-disabled" title="客户端离线，无法踢掉">
            <i class="layui-icon layui-icon-logout"></i> 踢掉
        </a>
        {{# } }}
        <a class="layui-btn layui-btn-xs" lay-event="edit"><i class="layui-icon layui-icon-edit"></i> 编辑</a>
        <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="delete"><i
                class="layui-icon layui-icon-delete"></i> 删除</a>
    </div>
</script>
<script src="/static/layui/layui.js"></script>
<script src="/static/ajax.js"></script>
<script>
    layui.use(['table', 'dropdown', 'jquery'], function () {
        var table = layui.table;
        const $ = layui.$;
        table.render({
            elem: '#client',
            url: '/client/list',
            toolbar: '#headerToolbar',
            height: 'full-35',
            cols: [[
                {field: 'name', fixed: 'left', width: 150, title: '客户端'},
                {field: 'secretKey', title: 'Token'},
                {
                    field: 'status', title: '状态', sort: true, templet: function (d) {
                        if (d.status === 1) {
                            return ' <span class="layui-badge layui-bg-green">在线</span>';
                        } else if (d.status === 0) {
                            return '<span class="layui-badge">离线</span>';
                        }
                    }
                },
                {fixed: 'right', title: '操作', width: 256, templet: '#tableToolbar'}
            ]],
            error: function (res, msg) {
                console.log(res, msg)
            }
        });
        //单元格操作事件
        table.on('tool(client)', function (obj) {
            const data = obj.data;
            if (obj.event === 'kickout') {
                layer.confirm('确定踢掉「' + data.name + '」客户端吗？<br>此操作将会断开所有已建立的连接！',
                    {
                        icon: 2,
                        title: '危险操作确认',
                        skin: 'layui-layer-molv',
                        btn: ['确认踢掉', '我再想想'],
                    }, function (index) {
                        $.ajax({
                            url: '/client/kickout',
                            type: 'delete',
                            contentType: 'application/json',
                            data: JSON.stringify({id: data.id, secretKey: data.secretKey}),
                            headers: {},
                            success: function (res) {
                                if (res.code === 0) {
                                    table.reload('client')
                                    layer.msg("已跌掉", {time: 2000});
                                } else {
                                    layer.msg(res.message, {time: 2000});
                                }
                            },
                        });
                    })
            } else if (obj.event === 'edit') {
                layer.open({
                    title: '编辑',
                    type: 2,
                    offset: '30px',
                    shade: false,
                    area: ['40%', '30%'],
                    content: '/client/edit.html?id=' + data.id
                });
            } else if (obj.event === 'delete') {
                layer.confirm('确定删除「' + data.name + '」客户端吗？<br>此操作将会删除所有端口映射，包括运行中的映射！',
                    {
                        icon: 2,
                        title: '危险操作确认',
                        skin: 'layui-layer-molv',
                        btn: ['确认删除', '我再想想'],
                    }, function (index) {
                        $.ajax({
                            url: '/client/del',
                            type: 'delete',
                            contentType: 'application/json',
                            data: JSON.stringify({id: data.id}),
                            headers: {},
                            success: function (res) {
                                if (res.code === 0) {
                                    table.reload('client')
                                    layer.msg("删除成功", {time: 2000});
                                } else {
                                    layer.msg(res.message, {time: 2000});
                                }
                            },
                        });
                    });

            }
        })
        //操作工具栏
        table.on('toolbar(client)', function (obj) {
            if (obj.event === 'add') {
                layer.open({
                    title: '新增客户端',
                    type: 2,
                    offset: '30px',
                    shade: false,
                    area: ['40%', '30%'],
                    content: '/client/add.html'
                });
            } else if (obj.event === 'flush') {
                table.reload('client')
            }
        })
    })
</script>
</body>
</html>
