<!DOCTYPE html>
<html>
<head>
    <title>客户端</title>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/static/layui/css/layui.css" rel="stylesheet">
    <link href="/static/css/client-index.css" rel="stylesheet">
    <link href="/static/css/app.css" rel="stylesheet">
</head>
<body>
<div class="page-container">
    <div class="toolbar-section">
        <button class="layui-btn layui-btn-sm layui-btn-normal" id="addClientBtn">
            <i class="layui-icon layui-icon-add-1"></i> 新增
        </button>
        <button class="layui-btn layui-btn-sm" id="refreshBtn">
            <i class="layui-icon layui-icon-refresh-3"></i> 刷新
        </button>
    </div>

    <div class="cards-section">
        <div id="loadingState" class="loading-state" style="display: none;">
            <div class="loading-spinner">
                <i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate"></i>
            </div>
            <div class="loading-text">加载中...</div>
        </div>

        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-icon">
                <i class="layui-icon layui-icon-face-cry"></i>
            </div>
            <div class="empty-text">暂无客户端数据</div>
            <button class="layui-btn layui-btn-sm layui-btn-normal" id="addFirstClientBtn">
                <i class="layui-icon layui-icon-add-1"></i> 添加第一个客户端
            </button>
        </div>

        <div id="cardContainer" class="cards-grid"></div>
    </div>
</div>

<script src="/static/layui/layui.js"></script>
<script src="/static/js/ajax.js"></script>
<script src="/static/js/copy.js"></script>
<script>
    function getOsIcon(osName) {
        const os = osName.toLowerCase();
        const base = '/static/icons/'
        if (os === 'windows') {
            return base + 'windows.svg'
        } else if (os === 'macos') {
            return base + 'mac-os.svg'
        } else if (os === 'linux') {
            return base + 'linux.svg'
        } else {
            return base + 'unknown.svg'
        }
    }

    function showLoading() {
        document.getElementById('loadingState').style.display = 'flex';
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('cardContainer').style.display = 'none';
    }

    function hideLoading() {
        document.getElementById('loadingState').style.display = 'none';
    }

    function showEmptyState() {
        document.getElementById('emptyState').style.display = 'flex';
        document.getElementById('cardContainer').style.display = 'none';
    }

    function showCards() {
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('cardContainer').style.display = 'grid';
    }

    function renderClientCards(clients) {
        const container = document.getElementById('cardContainer');
        container.innerHTML = '';

        if (!clients || clients.length === 0) {
            showEmptyState();
            return;
        }

        showCards();

        clients.forEach(client => {
            const cardHtml = `
                <div class="client-card" data-client-id="${client.id}">
                    <div class="card-header">
                        <div class="card-title" title="${client.name}">${client.name}</div>
                        <div class="card-actions">
                            <div class="card-action-btn edit-btn" data-id="${client.id}" style="color: #1E9FFF;">编辑</div>
                            <div class="card-action-btn delete-btn" data-id="${client.id}" style="color: #FF5722;">删除</div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="status-icon">
                            <img src="/static/image/icon/${client.status === 1 ? 'connected' : 'disconnect'}.svg" style="width: 50px;height: 50px;">
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="footer-action copy-token-btn" data-token="${client.secretKey}" style="color: #16baaa;">复制Token</div>
                        <div class="footer-action kickout-btn" data-id="${client.id}" data-name="${client.name}" data-token="${client.secretKey}" style="color: #FFB800;${client.status !== 1 ? 'opacity: 0.5; pointer-events: none;' : ''}">强制下线</div>
                    </div>
                </div>
            `;
            container.innerHTML += cardHtml;
        });

        bindCardEvents();
    }

    function updateCardStatus(clientId, isOnline) {
        const card = document.querySelector(`.client-card[data-client-id="${clientId}"]`);
        if (!card) return;

        // 更新状态图标
        const statusIcon = card.querySelector('.status-icon img');
        if (statusIcon) {
            statusIcon.src = `/static/image/icon/${isOnline ? 'connected' : 'disconnect'}.svg`;
        }

        // 更新强制下线按钮状态
        const kickoutBtn = card.querySelector('.kickout-btn');
        if (kickoutBtn) {
            if (isOnline) {
                kickoutBtn.style.opacity = '1';
                kickoutBtn.style.pointerEvents = 'auto';
            } else {
                kickoutBtn.style.opacity = '0.5';
                kickoutBtn.style.pointerEvents = 'none';
            }
        }
    }

    function bindCardEvents() {
        // 编辑事件
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const clientId = this.getAttribute('data-id');
                layer.open({
                    title: '编辑',
                    type: 2,
                    offset: '30px',
                    shade: false,
                    area: ['40%', '30%'],
                    content: '/client/edit.html?id=' + clientId
                });
            });
        });

        // 删除事件
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const clientId = this.getAttribute('data-id');
                const clientName = this.closest('.client-card').querySelector('.card-title').textContent;

                layer.confirm('确定删除「' + clientName + '」客户端吗？',
                    {
                        icon: 2,
                        title: '危险操作确认',
                        skin: 'layui-layer-molv',
                        btn: ['确认删除', '我再想想'],
                    }, function (index) {
                        layui.Rest.delete('/api/client/del', {id: clientId}).then(res => {
                            loadClientData();
                            layer.msg("删除成功", {time: 2000});
                        });
                    });
            });
        });

        // 复制Token事件
        document.querySelectorAll('.copy-token-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const token = this.getAttribute('data-token');
                ClipMaster.copy(token);
            });
        });

        // 强制下线事件
        document.querySelectorAll('.kickout-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const clientId = this.getAttribute('data-id');
                const clientName = this.getAttribute('data-name');
                const token = this.getAttribute('data-token');

                layer.confirm('确定强制下线「' + clientName + '」？',
                    {
                        icon: 2,
                        title: '危险操作确认',
                        skin: 'layui-layer-molv',
                        btn: ['确认', '再想想'],
                    }, function (index) {
                        layui.Rest.delete('/api/client/kickout', {id: clientId, secretKey: token}).then(res => {
                            updateCardStatus(clientId, false);
                            layer.msg("强制下线", {time: 2000});
                        })
                    });
            });
        });
    }

    function loadClientData() {
        showLoading();

        layui.use(['jquery', 'Rest'], function () {
            const Rest = layui.Rest;
            const $ = layui.$;

            Rest.get('/api/client/list', {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem("auth_token")
                }
            }).then(res => {
                hideLoading();
                if (res) {
                    renderClientCards(res || []);
                }
            }).catch(err => {
                hideLoading();
                renderClientCards([]);
                layer.msg('网络错误: ' + err.message, {icon: 2});
            });
        });
    }

    layui.use(['layer', 'jquery', 'Rest'], function () {
        const layer = layui.layer;
        const $ = layui.$;

        // 加载数据
        loadClientData();

        // 新增按钮事件
        $('#addClientBtn').on('click', function () {
            layer.open({
                title: '新增客户端',
                type: 2,
                offset: '30px',
                shade: false,
                area: ['40%', '30%'],
                content: '/client/add.html'
            });
        });

        // 刷新按钮事件
        $('#refreshBtn').on('click', function () {
            loadClientData();
            layer.msg('刷新成功', {time: 1000});
        });

        // 空状态添加按钮事件
        $('#addFirstClientBtn').on('click', function () {
            layer.open({
                title: '新增客户端',
                type: 2,
                offset: '30px',
                shade: false,
                area: ['40%', '30%'],
                content: '/client/add.html'
            });
        });
    });
</script>
</body>
</html>
