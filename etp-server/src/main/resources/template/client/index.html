<!DOCTYPE html>
<html>
<head>
    <title>客户端</title>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/static/layui/css/layui.css" rel="stylesheet">
    <link href="/static/css/client-index.css" rel="stylesheet">
</head>
<body>
<table class="layui-hide" id="client" lay-filter="client"></table>
<script type="text/html" id="headerToolbar">
    <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm layui-btn-normal" lay-event="add">
            <i class="layui-icon layui-icon-add-1"></i> 新增
        </button>
        <button class="layui-btn layui-btn-sm" lay-event="flush">
            <i class="layui-icon layui-icon-refresh-3"></i> 刷新
        </button>
    </div>
</script>
<script type="text/html" id="tableToolbar">
    <div class="layui-clear-space">
        {{# if(d.status === 1){ }}
        <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="kickout">
            <i class="layui-icon layui-icon-logout"></i> 踢掉
        </a>
        {{# } else { }}
        <a class="layui-btn layui-btn-xs layui-btn-disabled" title="客户端离线，无法踢掉">
            <i class="layui-icon layui-icon-logout"></i> 踢掉
        </a>
        {{# } }}
        <a class="layui-btn layui-btn-xs" lay-event="edit"><i class="layui-icon layui-icon-edit"></i> 编辑</a>
        <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="delete"><i
                class="layui-icon layui-icon-delete"></i> 删除</a>
    </div>
</script>
<script src="/static/layui/layui.js"></script>
<script src="/static/js/ajax.js"></script>
<script src="/static/js/copy.js"></script>
<script>
    function getOsIcon(osName) {
        const os = osName.toLowerCase();
        const base = '/static/icons/'
        if (os === 'windows') {
            return base + 'windows.svg'
        } else if (os === 'macos') {
            return base + 'mac-os.svg'
        } else if (os === 'linux') {
            return base + 'linux.svg'
        } else {
            return base + 'unknown.svg'
        }
    }

    layui.use(['table', 'dropdown', 'jquery', 'Rest'], function () {
        var table = layui.table;
        var Rest = layui.Rest;
        const $ = layui.$;
        table.render({
            elem: '#client',
            url: '/api/client/list',
            toolbar: '#headerToolbar',
            height: 'full-35',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem("auth_token")
            },
            cols: [[
                {field: 'name', fixed: 'left', width: 150, title: '客户端名'},
                {
                    field: 'secretKey',
                    title: 'Token',
                    templet: function (d) {
                        return `
                         <div style="display:flex; align-items:center; gap:2px; font-size:14px; font-weight:600;">
                           <span>${d.secretKey}</span>
                          <a href="javascript:;" lay-event="copyToken" class="layui-btn layui-btn-xs layui-btn-primary"
                              style="border:none; background:transparent; " title="点击复制Token">
                             <i class="layui-icon layui-icon-file" style="color:#16baaa; font-size:16px;"></i>
                           </a>
                        </div>
                    `;
                    }
                },
                {
                    field: 'status', title: '状态', sort: true,
                    templet: function (d) {
                        if (d.status === 1) {
                            return `
                <div style="display: flex; justify-content: space-between; align-items: center">
                    <div style="display: flex; align-items: center;">
                        <i class="layui-icon layui-icon-circle-dot status-breath"
                        style="font-size:16px; color:#16b777; margin-right:6px;"></i>
                        <span style="color:#16b777; font-weight:500;">在线</span>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <img  style="height: 24px;width: 24px;margin-right: 2px"  src="${getOsIcon(d.os)}">
                        <span style="font-weight:500;color: #333;font-size: 15px">${d.os || ''}</span>
                        <span class="layui-badge layui-bg-cyan" style=" font-size:15px; margin-left:15px;">${d.arch || ''}</span>
                    </div>
                </div>
            `;
                        } else {
                            return `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center;">
                        <i class="layui-icon layui-icon-circle-dot"
                        style="font-size:16px; color:gray; margin-right:6px;"></i>
                        <span style="color:#999;">离线</span>
                    </div>
                    <div></div>
                </div>
            `;
                        }
                    }
                },
                {fixed: 'right', title: '操作', width: 240, templet: '#tableToolbar'}
            ]],
            error: function (res, msg) {
                console.log(res, msg)
            }
        });
        //单元格操作事件
        table.on('tool(client)', function (obj) {
            const data = obj.data;
            if (obj.event === 'kickout') {
                layer.confirm('确定踢掉「' + data.name + '」客户端吗？<br>此操作将会断开所有已建立的连接！',
                    {
                        icon: 2,
                        title: '危险操作确认',
                        skin: 'layui-layer-molv',
                        btn: ['确认踢掉', '我再想想'],
                    }, function (index) {
                        Rest.delete('/api/client/kickout', {id: data.id, secretKey: data.secretKey}).then(res => {
                            table.reload('client')
                            layer.msg("已跌掉", {time: 2000});
                        })
                    })
            } else if (obj.event === 'edit') {
                layer.open({
                    title: '编辑',
                    type: 2,
                    offset: '30px',
                    shade: false,
                    area: ['40%', '30%'],
                    content: '/client/edit.html?id=' + data.id
                });
            } else if (obj.event === 'delete') {
                layer.confirm('确定删除「' + data.name + '」客户端吗？<br>此操作将会删除所有端口映射，包括运行中的映射！',
                    {
                        icon: 2,
                        title: '危险操作确认',
                        skin: 'layui-layer-molv',
                        btn: ['确认删除', '我再想想'],
                    }, function (index) {
                        Rest.delete('/api/client/del', {id: data.id}).then(res => {
                            table.reload('client')
                            layer.msg("删除成功", {time: 2000});
                        })
                    });

            } else if (obj.event === 'copyToken') {
                ClipMaster.copy(data.secretKey);
            }
        })
        //操作工具栏
        table.on('toolbar(client)', function (obj) {
            if (obj.event === 'add') {
                layer.open({
                    title: '新增客户端',
                    type: 2,
                    offset: '30px',
                    shade: false,
                    area: ['40%', '30%'],
                    content: '/client/add.html'
                });
            } else if (obj.event === 'flush') {
                table.reload('client')
            }
        })
    })
</script>
</body>
</html>
