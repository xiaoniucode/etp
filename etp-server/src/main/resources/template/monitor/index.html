<!DOCTYPE html>
<html>
<head>
    <title>监控</title>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/static/layui/css/layui.css" rel="stylesheet">
    <link href="/static/css/monitor.css" rel="stylesheet">
    <link href="/static/css/app.css" rel="stylesheet">
</head>
<body>
<div class="page-main">
    <div class="layui-row" style="text-align: center">
        <div class="layui-col-sm3 padding-right15">
            <div class="dashboard-card">
                <div class="card-icon">
                    <img src="/static/icons/client.svg" alt="">
                </div>
                <div class="card-content">
                    <div class="card-title">客户端总数</div>
                    <div class="card-value" id="clientTotal">--</div>
                </div>
            </div>
        </div>

        <div class="layui-col-sm3 padding-right15">
            <div class="dashboard-card">
                <div class="card-icon">
                    <img src="/static/icons/online.svg" alt="">
                </div>
                <div class="card-content">
                    <div class="card-title">在线客户端数</div>
                    <div class="card-value" id="onlineClient">--</div>
                </div>
            </div>
        </div>

        <div class="layui-col-sm3 padding-right15">
            <div class="dashboard-card">
                <div class="card-icon">
                    <img src="/static/icons/connect.svg" alt="">
                </div>
                <div class="card-content">
                    <div class="card-title">隧道总数</div>
                    <div class="card-value" id="mappingTotal">--</div>
                </div>
            </div>
        </div>

        <div class="layui-col-sm3">
            <div class="dashboard-card">
                <div class="card-icon">
                    <img src="/static/icons/running.svg" alt="">
                </div>
                <div class="card-content">
                    <div class="card-title">已启动隧道数</div>
                    <div class="card-value" id="startMapping">--</div>
                </div>
            </div>
        </div>
    </div>
    <!--仪表盘-->
    <div class="layui-row" style="margin-top: 20px;">
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-header">系统监控</div>
                <div class="layui-card-body">
                    <div class="layui-row layui-col-space20">
                        <div class="layui-col-md4">
                            <div id="cpu-chart" style="width: 100%;height:350px;"></div>
                            <div style="text-align: center; margin-top: 10px; font-size: 16px; color: #333; font-weight: 500;"
                                 id="cpu-info">
                                <span>CPU使用率：45%</span>
                            </div>
                        </div>
                        <div class="layui-col-md4"
                             style="border-left: 1px solid #e6e6e6; border-right: 1px solid #e6e6e6;">
                            <div id="heap-chart" style="width: 100%;height:350px;"></div>
                            <div style="text-align: center; margin-top: 10px; font-size: 16px; color: #333; font-weight: 500;"
                                 id="heap-info">
                                <span>堆内存：2.7GB / 4GB</span>
                            </div>
                        </div>
                        <div class="layui-col-md4">
                            <div id="ram-chart" style="width: 100%;height:350px;"></div>
                            <div style="text-align: center; margin-top: 10px; font-size: 16px; color: #333; font-weight: 500;"
                                 id="ram-info">
                                <span>物理内存：5.1GB / 16GB</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="layui-row layui-col-space20" style="margin-top: 20px;">
        <div class="layui-col-md6">
            <div class="layui-card">
                <div class="layui-card-header">实时流量</div>
                <div class="layui-card-body">
                    <div id="traffic-chart" style="width: 100%;height:350px;"></div>
                </div>
            </div>
        </div>
        <div class="layui-col-md6">
            <div class="layui-card">
                <div class="layui-card-header">隧道数量</div>
                <div class="layui-card-body">
                    <div id="protocol-chart" style="width: 100%;height:350px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!--系统配置信息 -->
    <div class="layui-row layui-col-space20" style="margin-top: 20px;">
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-header">配置信息</div>
                <div class="layui-card-body">
                    <form class="layui-form" lay-filter="sysConfigForm">

                        <!-- 第一行-->
                        <div class="layui-row layui-col-space20">
                            <div class="layui-col-md6">
                                <div class="layui-form-item">
                                    <label class="layui-form-label">隧道地址</label>
                                    <div class="layui-input-block">
                                        <input type="text" class="layui-input config-display" readonly name="host">
                                    </div>
                                </div>
                            </div>
                            <div class="layui-col-md6">
                                <div class="layui-form-item">
                                    <label class="layui-form-label">控制端口</label>
                                    <div class="layui-input-block">
                                        <input type="text" class="layui-input config-display" readonly name="bind_port">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 第二行 -->
                        <div class="layui-row layui-col-space20">
                            <div class="layui-col-md6">
                                <div class="layui-form-item">
                                    <label class="layui-form-label">端口范围</label>
                                    <div class="layui-input-block">
                                        <input type="text" class="layui-input config-display" readonly
                                               name="port_range">
                                    </div>
                                </div>
                            </div>
                            <div class="layui-col-md6">
                                <div class="layui-form-item">
                                    <label class="layui-form-label">TLS加密</label>
                                    <div class="layui-input-block">
                                        <input type="text" class="layui-input config-display" readonly
                                               name="tls_enabled">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


</div>
<script src="/static/layui/layui.js"></script>
<script src="/static/echart/echarts.min.js"></script>
<script src="/static/js/ajax.js"></script>
<script>
    layui.use(['jquery', 'Rest'], function () {
        var Rest = layui.Rest;
        const $ = layui.$;
        var form = layui.form;
        let charts = [];

        $(function () {
            // 获取基础监控数据
            Rest.get('/api/monitor').then(data => {
                const {stats, sysConfig} = data
                $('#clientTotal').text(stats.clientTotal);
                $('#onlineClient').text(stats.onlineClient);
                $('#mappingTotal').text(stats.mappingTotal);
                $('#startMapping').text(stats.startMapping);

                // 系统配置
                const start = sysConfig.port_range_start || '';
                const end = sysConfig.port_range_end || '';
                const portRange = start && end ? `${start} - ${end}` : (start || end || '未设置');
                form.val('sysConfigForm', {
                    tls_enabled: sysConfig.tls_enabled,
                    host: sysConfig.host,
                    bind_port: sysConfig.bind_port,
                    port_range: portRange
                });
            });

            charts = initChart();

            // 初始加载服务器监控数据
            loadServerMonitorData();

            // 每3秒刷新一次服务器监控数据
            setInterval(loadServerMonitorData, 3000);
        });

        // 加载服务器监控数据
        function loadServerMonitorData() {
            Rest.get('/api/monitor/server', {}, {loading: false}).then(data => {
                updateCharts(data);
            });
        }

        function updateCharts(serverData) {
            const {cpu, jvmMem, osMem} = serverData;

            charts.forEach(item => {
                const {chart, config, type} = item;

                if (type === 'pie') {
                    return;
                }

                let value = 0;
                let used = '';
                let total = '';

                if (config.id === 'cpu-chart') {
                    value = cpu.usage;
                    $('#cpu-info').html(`<span>CPU使用率：${value}%</span>`);
                } else if (config.id === 'heap-chart') {
                    value = jvmMem.usage;
                    used = jvmMem.used;
                    total = jvmMem.total;
                    $('#heap-info').html(`<span>堆内存：${used} / ${total}</span>`);
                } else if (config.id === 'ram-chart') {
                    value = osMem.usage;
                    used = osMem.used;
                    total = osMem.total;
                    $('#ram-info').html(`<span>物理内存：${used} / ${total}</span>`);
                }
                // 更新仪表盘
                chart.setOption({
                    series: [
                        {
                            data: [{value: value, name: config.name}]
                        }
                    ]
                });
            });
        }
    });

    function initChart() {
        const chartConfig = [
            {id: 'cpu-chart', name: 'CPU', value: 45, total: '100%'},
            {id: 'heap-chart', name: '堆内存', value: 68, total: '4GB'},
            {id: 'ram-chart', name: '物理内存', value: 32, total: '16GB'}
        ];
        const charts = [];

        chartConfig.forEach(config => {
            var chartDom = document.getElementById(config.id);
            var myChart = echarts.init(chartDom);

            var option = {
                series: [
                    {
                        name: '使用率',
                        type: 'gauge',
                        detail: {
                            formatter: '{value}%'
                        },
                        data: [
                            {
                                value: config.value,
                                name: config.name
                            }
                        ]
                    }
                ]
            };

            myChart.setOption(option);
            charts.push({
                chart: myChart,
                name: config.name,
                config: config
            });
        });

        // 饼图配置
        const pieChartConfig = [
            {
                id: 'protocol-chart',
                name: '隧道数量',
                data: [
                    {value: 1048, name: 'TCP'},
                    {value: 735, name: 'HTTP'}
                ]
            },
            {
                id: 'traffic-chart',
                name: '实时流量',
                data: [
                    {value: 1500, name: '入站流量'},
                    {value: 800, name: '出站流量'}
                ]
            }
        ];

        pieChartConfig.forEach(config => {
            var chartDom = document.getElementById(config.id);
            var myChart = echarts.init(chartDom);

            var option = {
                title: {
                    text: config.name,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item'
                },
                legend: {
                    orient: 'vertical',
                    left: 'left'
                },
                series: [
                    {
                        name: config.name,
                        type: 'pie',
                        radius: '50%',
                        data: config.data,
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        }
                    }
                ]
            };

            myChart.setOption(option);
            charts.push({
                chart: myChart,
                name: config.name,
                config: config,
                type: 'pie'
            });
        });

        return charts;
    }
</script>
</body>
</html>
