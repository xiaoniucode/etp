<!DOCTYPE html>
<html lang="en">
<head>
    <title>统计</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link href="/static/layui/css/layui.css" rel="stylesheet">
</head>
<body>
<blockquote class="layui-elem-quote">
    统计信息目前尚未做持久化！
</blockquote>
<script type="text/html" id="statsToolbar">
    <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm" lay-event="flush">
            <i class="layui-icon layui-icon-refresh"></i> 刷新
        </button>
    </div>
</script>
<table class="layui-hide" id="metrics" lay-filter="metrics"></table>
<script type="text/html" id="post_table_tool">
    <div class="layui-clear-space">
        <a class="layui-btn layui-btn-xs" lay-event="view">详细</a>
    </div>
</script>
<script src="/static/layui/layui.js"></script>
<script>
    layui.use(['form', 'table', 'dropdown'], function () {
        const table = layui.table;
        table.render({
            elem: '#metrics',
            text: "空空如也",
            skin: "line",
            url: '/api/metrics',
            toolbar: '#statsToolbar',
            cellMinWidth: 80,
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem("auth_token")
            },
            cols: [[
                {field: 'remotePort', fixed: 'left', width: 120, title: '公网端口', sort: true},
                {field: 'channels',  title: '连接数', sort: true, align: 'center'},

                // 上行（外网 → 你服务器）
                {
                    field: 'readBytes', title: '上行流量', sort: true,
                    templet: d => formatBytes(d.readBytes)
                },
                {field: 'readMsgs', title: '接收消息数', sort: true},

                // 下行（你服务器 → 外网）
                {
                    field: 'writeBytes', title: '<strong>下行流量</strong>', sort: true,
                    templet: d => '<strong style="color:#16baaa;">' + formatBytes(d.writeBytes) + '</strong>'
                },
                {field: 'writeMsgs', title: '发送消息数', sort: true},

                {
                    field: 'time', title: '统计时间', sort: true, width: 180,
                    templet: d => layui.util.toDateString(d.time, 'yyyy-MM-dd HH:mm')
                }
            ]],
            error: function (res, msg) {
                console.log(res, msg)
            }
        });

        // 自动把字节数转成 B/KB/MB/GB/TB
        function formatBytes(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        table.on('toolbar(metrics)', function (obj) {
            if (obj.event === 'flush') {
                table.reload('metrics');
            }
        });
    });
</script>
</body>
