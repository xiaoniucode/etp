name: ğŸš€ æ„å»ºè·¨å¹³å°ç¨‹åºä¸å‘å¸ƒ

on:
  workflow_dispatch:    # ğŸ® æ‰‹åŠ¨è§¦å‘
  push:
    tags:
      - 'v*'           # ğŸ·ï¸ ç‰ˆæœ¬æ ‡ç­¾è§¦å‘
env:
  JAVA_VERSION: '21'

jobs:
  # ğŸ”¨ æ„å»ºåŸç”Ÿé•œåƒï¼ˆå¤šå¹³å°ï¼‰
  build-native:
    name: ğŸ”¨ æ„å»ºåŸç”Ÿé•œåƒ - ${{ matrix.display_name }}
    strategy:
      fail-fast: false  # âš¡ ä¸€ä¸ªå¹³å°å¤±è´¥ä¸å½±å“å…¶ä»–å¹³å°
      matrix:
        include:
       #   ğŸ§ Linux å¹³å°
          - os: ubuntu-latest
            platform: linux
            arch: amd64
            artifact_suffix: linux_amd64
            display_name: "Linux AMD64"
          - os: ubuntu-latest
            platform: linux
            arch: arm64
            artifact_suffix: linux_arm64
            display_name: "Linux ARM64"

          # ğŸªŸ Windows å¹³å°
          - os: windows-latest
            platform: windows
            arch: amd64
            artifact_suffix: windows_amd64
            display_name: "Windows AMD64"

          # ğŸ macOS å¹³å°
          - os: macos-latest
            platform: darwin
            arch: amd64
            artifact_suffix: darwin_amd64
            display_name: "macOS AMD64"
          - os: macos-latest
            platform: darwin
            arch: arm64
            artifact_suffix: darwin_arm64
            display_name: "macOS ARM64"

    runs-on: ${{ matrix.os }}
    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: â˜• è®¾ç½® GraalVM ç¯å¢ƒ
        uses: graalvm/setup-graalvm@v1
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'graalvm'
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ’¾ ç¼“å­˜ Maven ä¾èµ–
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ matrix.platform }}-${{ matrix.arch }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ matrix.platform }}-${{ matrix.arch }}-maven-
      - name: ğŸ—ï¸ æ„å»º æ¨¡å—åŸç”Ÿé•œåƒ
        run: mvn clean install native:compile -Pnative -am -DskipTests --no-transfer-progress
      # Linux/macOS æ‰“åŒ…
      - name: ğŸ“¦ æ‰“åŒ…Unixå‘å¸ƒæ–‡ä»¶
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          VERSION="${{ github.ref_name }}"
          RELEASE_NAME="etp_${VERSION}_${{ matrix.artifact_suffix }}"

          mkdir -p "$RELEASE_NAME"
          cp "etp-server/target/etp-server" "$RELEASE_NAME/etps"
          cp "etp-client/target/etp-client" "$RELEASE_NAME/etpc"

          cp etp-server/target/classes/*.toml "$RELEASE_NAME/" 2>/dev/null || true
          cp etp-client/target/classes/*.toml "$RELEASE_NAME/" 2>/dev/null || true

          tar -czf "$RELEASE_NAME.tar.gz" "$RELEASE_NAME"
          echo "âœ… Unixæ‰“åŒ…å®Œæˆ: $RELEASE_NAME.tar.gz"
      # Windows æ‰“åŒ…
      - name: ğŸ“¦ æ‰“åŒ…Windowså‘å¸ƒæ–‡ä»¶
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $VERSION = "${{ github.ref_name }}"
          $RELEASE_NAME = "etp_${VERSION}_${{ matrix.artifact_suffix }}"

          New-Item -ItemType Directory -Force -Path $RELEASE_NAME
          Copy-Item "etp-server\target\etp-server.exe" "$RELEASE_NAME\etps.exe"
          Copy-Item "etp-client\target\etp-client.exe" "$RELEASE_NAME\etpc.exe"

          Copy-Item "etp-server/target/classes/*.toml" $RELEASE_NAME -ErrorAction SilentlyContinue
          Copy-Item "etp-client/target/classes/*.toml" $RELEASE_NAME -ErrorAction SilentlyContinue

          Compress-Archive -Path "$RELEASE_NAME\*" -DestinationPath "$RELEASE_NAME.zip"
          Write-Host "âœ… Windowsæ‰“åŒ…å®Œæˆ: $RELEASE_NAME.zip"
      - name: â¬†ï¸ ä¸Šä¼ æ„ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: etp-${{ matrix.artifact_suffix }}-${{ github.ref_name }}
          path: etp_${{ github.ref_name }}_${{ matrix.artifact_suffix }}.*

  # ğŸ“¦ æ„å»º JAR åŒ…
  build-jar:
    name: ğŸ“¦ æ„å»º JAR åŒ…
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: â˜• è®¾ç½® Java ç¯å¢ƒ
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: ğŸ—ï¸ æ„å»ºæ¨¡å— JAR
        run: mvn clean install package -DskipTests -Dnative.skip=true --no-transfer-progress
      - name: ğŸ“¦ æ‰“åŒ… JAR å‘å¸ƒæ–‡ä»¶
        shell: bash
        run: |
          VERSION="${{ github.ref_name }}"
          RELEASE_NAME="etp_${VERSION}_jdk${{ env.JAVA_VERSION }}_jar"

          mkdir -p "$RELEASE_NAME"
          SERVER_JAR=$(find etp-server/target -name "etp-server-*.jar" | head -1)
          CLIENT_JAR=$(find etp-client/target -name "etp-client-*.jar" | head -1)

          cp "$SERVER_JAR" "$RELEASE_NAME/etps.jar"
          cp "$CLIENT_JAR" "$RELEASE_NAME/etpc.jar"

          cp etp-server/target/classes/*.toml "$RELEASE_NAME/" 2>/dev/null || true
          cp etp-client/target/classes/*.toml "$RELEASE_NAME/" 2>/dev/null || true

          zip -r "$RELEASE_NAME.zip" "$RELEASE_NAME"
          echo "âœ… JARåŒ…æ‰“åŒ…å®Œæˆ: $RELEASE_NAME.zip"
      - name: â¬†ï¸ ä¸Šä¼  JAR æ„ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: etp-jar-${{ github.ref_name }}-jdk${{ env.JAVA_VERSION }}
          path: etp_${{ github.ref_name }}_jdk${{ env.JAVA_VERSION }}_jar.zip

  # ğŸš€ ç»Ÿä¸€å‘å¸ƒé˜¶æ®µ
  create-release:
    name: ğŸš€ åˆ›å»ºç»Ÿä¸€ Release
    needs: [build-native, build-jar]
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰æ„ä»¶
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          pattern: '*'
          merge-multiple: true

      - name: ğŸ·ï¸ åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**/*
          generate_release_notes: true
